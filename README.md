# findmalware
A script that tries to guess presence of malicious code in PHP files. 
It does NOT look for known malware code fragments, but it uses a set 
of rules to infer what pieces PHP code are likely malware. As such it 
produces many false positives, so it uses a whitelist to avoid showing 
files that are known to be good.

It analyzes every file whose name ends in '.php' looking for them
recursively in the current directory.

_Please note that this script does **NOT** delete nor sanitize **ANYTHING**.  
It only produces a report. It's up to the sysadmin (e.g. YOU) to read that 
report and take action_. As such, it is safe to run this script anywhere 
you like: it won't even notice if you run it in a read-only filesystem,
as long as you have a working mktemp installed.

### This script depends on
1. mktemp
2. GNU find
3. GNU grep
4. GNU sed
5. GNU screen
6. sha512
7. curl for the autoupdate feature
8. maybe a bunch of other rather common system commands

### Usage:
  findmalware.sh _[-c configfile] [-b local_blacklist_file] 
    [-B upstream_blacklist_file] [-w local_whitelist_file] 
    [-W upstream_whitelist_file] [-r local_rules_file]
    [-R upstream_rules_file] [-u upstream_url] [-a] [-A] [-h]_

  where

  -c _configfile_
       Specifies a custom configuration file to load after the 
       default ones. Every configuration file is a bash fragment that
       this script includes untouched. This option is parsed before
       other options, so that command line arguments can override any
       settings in configuration files. Default configuration files
       that are ALWAYS loaded if readable, whether you use this option
       or not, are:

      * /etc/findmalware.conf
      * /usr/local/etc/findmalware.conf
      * $HOME/.findmalware.conf
      * $HOME/.config/findmalware.conf
      * $HOME/.findmalware/config

       in that order. If you specify a custom configuration file and
       that file is not readable, the script aborts execution by
       design. The FINDMALWARE_CONFIG environment variable can be 
       used instead of this option, but if both are specified, this
       option takes precedence.

 -b _local_blacklist_file_ 
       specifies a blacklist file to use as a cache. This file needs 
       to be writeable in order to be of any use. However you can
       live without it, it's really only a way to avoid showing two
       suspect files when they have exactly the same content and the
       user has alreay tagged the first one as suspect. A local
       blacklist can save you quite some time if you scan for malware
       a directory that contains a website and one or more of its 
       backups. It defaults to $HOME/.findmalware/blacklist.local

  -B _upstream_blacklist_file_ 
       same as -b, but it specifies a local copy of a upstream 
       blacklist, possibly downloaded from the internet. This can be
       a read-only file, but if you use the autoupdate feature 
       (-a option), then this file and its parent directory need
       to be writeable for you to blacklist anything.
       It defaults to $HOME/.findmalware/blacklist

  -w _local_whitelist_file_ 
       specifies a whitelist file to use as a cache. For each false
       positive file, the user can choose to whitelist it. The script
       then adds the file name, size and checksum to this whitelist
       file. If a file is whitelisted it won't be shown to the user
       again in the future, but the script will only add a notice to
       the scan report. Please note that whitelisting a file by 
       mistake can defeat the whole pourpose of this script, so pay
       attention before whitelisting a file and, if you are not sure,
       you better avoid whitelisting anything. This file needs to be
       writeable for you to whitelist anything.
       It defaults to $HOME/.findmalware/whitelist.local

  -W _upstream_whitelist_file_ 
       same as -w, but it specifies a local copy of a upstream
       whitelist, possibly downloaded from the internet. This can be
       a read-only file, but if you use the autoupdate feature
       (-a option), then this file and its parent directory need
       to be writeable.
       Please note that downloading random whitelists from unknown
       sources for sake of saving some time during scans paves the 
       way to a slow and painful death. And no, you should NOT
       trust the official upstream whitelist published by the author 
       of this script either, unless you have a good reason.
       And please note that the author of this documentation is
       the same as the author of the script, and he is the one who
       publishes the default upstream whitelist too. In other words:
       do NOT trust ME, where "ME"="Lucio Crusca", your faithful 
       author of the script who has written this stuff. 
       I'm not saying I'm so bad, but I can make mistakes and you 
       can't hold me liable for that. You have been warned.
       That being said, this script works for me and I trust myself,
       so this script has the autoupdate feature enabled by default
       and it downloads my whitelist by default.
       This option defaults to $HOME/.findmalware/whitelist

  -r _local_rules_file_ 
       specifies a file containing rules, one per line. Rules are 
       regular expressions as recognized by grep. PHP files matching
       one or more rules are considered infected and shown to the
       user during scans. If you want to use more rules than the 
       default ones, you can write them in a file and pass the file
       to the script with this option. 
       It defaults to $HOME/.findmalware/rules.local

  -R _upstream_rules_file_ 
       same as -r, but it specifies a local copy of a upstream 
       rules file, possibly downloaded from the internet. If you use 
       the autoupdate feature (-a option), then this file and its parent 
       directory need to be writeable. 
       All the -W advices apply, so go read them if you haven't yet.
       It defaults to $HOME/.findmalware/rules

  -u _upstream_url_ 
       specifies the URL to use when autoupdating local copies 
       of upstream files.
       When autoupdating, this script looks for the following files
       online:
         * upstream_url/whitelist-latest.txt
         * upstream_url/blacklist-latest.txt
         * upstream_url/rules-latest.txt
       It uses _curl_ to check last modification date online and to 
       download them if needed.
       It defaults to https://webcloud.virtualbit.it/findmalware

  -a _[on|off]_ 
       enables or disables the autoupdate of the lists and rules. 
       It's enabled by default, for reasons you can find in the -W 
       documentation above. Haven't read that yet?
  
  -A _[on|off]_ 
       enables or disables the autoupdate of the script code
       itself. Defaults to "off". The "on" value is not implemented yet.

  -h 
       show this help and exits.


### CONFIGURATION FILES

  All options except "-h" have a matching variable 
  inside the script, so you can set them in configuration 
  files too, but see below for "-c".
  Here is the list of variables and their respective 
  controlling option. Options, if specified, take precedence 
  over configuration files.
  Environment variables by the same name of these ones are
  silently ignored.

    *  AUTOUPDATE_LISTS is controlled by -a
    *  AUTOUPDATE_SCRIPT is controlled by -A
    *  BLACKLIST_ADDITIONS is controlled by -b
    *  UPSTREAM_BLACKLIST is controlled by -B
    *  RULES_ADDITIONS is controlled by -r
    *  UPSTREAM_RULES is controlled by -R
    *  URL_FOR_UPSTREAM_LISTS is controlled by -u
    *  WHITELIST_ADDITIONS is controlled by -w
    *  UPSTREAM_WHITELIST is controlled by -W
    *  USERCONFFILE is controlled by -c, but...
      
  Additionally you can define the FINDMALWARE_CONFIG variable
  in your environment end export it to this script before 
  running it. Doing so will cause the specified value to be used
  as initialization for USERCONFFILE.
  Default configuration files can do whatever they see fit in
  variables values, including USERCONFFILE.
  Thus, it is theoretically possible to assign a value
  to USERCONFFILE inside one of the default configuration files,
  causing the specified conf-file to be loaded afterwards,
  but I suspect it makes little sense to do so.

